<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-10-17 Mon 20:50 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Debug an Aesara graph (advanced)</title>
<meta name="author" content="RÃ©mi Louf" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="style.css" /><script data-goatcounter="https://thetypicalset.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Debug an Aesara graph (advanced)</h1>

<div id="outline-container-org4a7ccc3" class="outline-2">
<h2 id="org4a7ccc3">The graph compiles, I get an ugly stack trace!</h2>
<div class="outline-text-2" id="text-org4a7ccc3">
<div class="org-src-container">
<pre class="src src-python">E   <span style="font-weight: bold; text-decoration: underline;">IndexError</span>: index out of bounds
E   Apply node that caused the error: Subtensor{int64, ::, int64}(BroadcastTo.0, ScalarConstant{0}, ScalarConstant{39})
E   Toposort index: 492
E   Inputs types: [TensorType(float64, (<span style="font-weight: bold; text-decoration: underline;">None</span>, <span style="font-weight: bold; text-decoration: underline;">None</span>, <span style="font-weight: bold; text-decoration: underline;">None</span>)), ScalarType(int64), ScalarType(int64)]
E   Inputs shapes: [(2401, 2, 2), (), ()]
E   Inputs strides: [(32, 16, 8), (), ()]
E   Inputs values: [<span style="font-style: italic;">'not shown'</span>, 0, 39]
E   Outputs clients: [[InplaceDimShuffle{x,0}(Subtensor{int64, ::, int64}.0)]]
</pre>
</div>

<ol class="org-ol">
<li>Re-run in a debugger</li>
<li>Go up (<code>u</code>) the stack trace</li>
<li><code>fgraph</code> (the function graph where the error occurs) should be avaible in the name space.</li>
<li>In the error message you should see indications such as <code>Toposort index: 492</code>, and this means that you can access the node via <code>node = fgraph.toposort()[492]</code></li>
<li>You can then inspect the resulting node, and see who created it by inspecting the tag <code>node.tag</code>.</li>
</ol>
</div>
</div>

<div id="outline-container-org75ef73b" class="outline-2">
<h2 id="org75ef73b">Clear the cache</h2>
<div class="outline-text-2" id="text-org75ef73b">
<p>
Sometimes it can be useful to clear the cache manually between different runs
</p>

<div class="org-src-container">
<pre class="src src-bash">aesara-cache clear
</pre>
</div>
</div>
</div>

<div id="outline-container-org2c9a8aa" class="outline-2">
<h2 id="org2c9a8aa">Pretty printing the graph</h2>
<div class="outline-text-2" id="text-org2c9a8aa">
<p>
Aeasara can return at a pretty-printed version of the graph:
</p>

<div class="org-src-container">
<pre class="src src-python">aesara.dprint(fgraph)
</pre>
</div>

<p>
This <code>dprint</code> function has a couple of interesting keyword arguments:
</p>
<ul class="org-ul">
<li><code>print_op_info=True</code> Gives annotation next to the Scan inputs</li>
<li><code>print_type_info=True</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgd0f075b" class="outline-2">
<h2 id="orgd0f075b">Rewrites applied to the graph</h2>
<div class="outline-text-2" id="text-orgd0f075b">
<p>
We can change the Logging properties using a context manager, fun.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">with</span> aesara.config.(rewrite_verbose=<span style="font-weight: bold; text-decoration: underline;">True</span>):
    Compile
</pre>
</div>
</div>
</div>

<div id="outline-container-org9763b1f" class="outline-2">
<h2 id="org9763b1f">Disable optimizations</h2>
<div class="outline-text-2" id="text-org9763b1f">
<p>
After examining the graph, and how the nodes were created you may suspect that a bug was introduced by a rewrite. The best way to confirm this hypothesis is usually to disable all rewrites at once. And then exclude individual rewrites to narrow it down.
</p>
</div>

<div id="outline-container-orgc2ecefd" class="outline-3">
<h3 id="orgc2ecefd">mode=Mode(optimizer="None")</h3>
</div>
<div id="outline-container-org4dfa3c5" class="outline-3">
<h3 id="org4dfa3c5">FAST<sub>RUN.excluding</sub>("&lt;name&gt;")</h3>
</div>
<div id="outline-container-orgb022fcc" class="outline-3">
<h3 id="orgb022fcc">If this is the inner-graph of a <code>Scan</code></h3>
<div class="outline-text-3" id="text-orgb022fcc">
<p>
Inner-graphs in <code>Scan</code> need to ave their set of optimizations set separately. It is then easier to use the global <code>aesara.config</code>. This is better done in <code>conftest.py</code> (the config needs to be updated before Aesara is initialized).
</p>

<div class="org-src-container">
<pre class="src src-python" id="org9a23e60"><span style="font-weight: bold;">import</span> os

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">pytest_sessionstart</span>(session):
    <span style="font-weight: bold; font-style: italic;">os.environ</span>[<span style="font-style: italic;">"AESARA_FLAGS"</span>] = <span style="font-style: italic;">","</span>.join(
        [
            os.environ.setdefault(<span style="font-style: italic;">"AESARA_FLAGS"</span>, <span style="font-style: italic;">""</span>),
            <span style="font-style: italic;">"warn__ignore_bug_before=all,on_opt_error=raise,on_shape_error=raise,optimizer_excluding=remove_constants_and_unused_inputs"</span>,
        ]
    )
</pre>
</div>

<p>
We're looking for the <code>optimizer_excluding</code> flag.
</p>
</div>
</div>
<div id="outline-container-org1cf70cd" class="outline-3">
<h3 id="org1cf70cd"><span class="todo TODO">TODO</span> Rich for graph folding project</h3>
</div>
<div id="outline-container-org0de4cd3" class="outline-3">
<h3 id="org0de4cd3"><span class="todo TODO">TODO</span> Add rewrite trajectory to a node's <code>tag</code> in the fully rewritten graph</h3>
<div class="outline-text-3" id="text-org0de4cd3">
<p>
Funny, isn't that something that we could easily deduct if the rewrites were described in an e-graph?
</p>
</div>
</div>
</div>

<div id="outline-container-orge42a698" class="outline-2">
<h2 id="orge42a698">Profile Aesara code</h2>
<div class="outline-text-2" id="text-orge42a698">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Enable profiling for compilation of the outer-function</span>
<span style="font-weight: bold; font-style: italic;">f_doubling</span> = aesara.function([A, B, tol, max_iter], gamma[-1], profile=<span style="font-weight: bold; text-decoration: underline;">True</span>)
f_doubling.profile.summary()
</pre>
</div>
</div>
</div>

<div id="outline-container-org54fa146" class="outline-2">
<h2 id="org54fa146">Links to this note</h2>
<div class="outline-text-2" id="text-org54fa146">
<ul class="org-ul">
<li><a href="./20220729163627-aesara.html">Aesara</a></li>
</ul>
</div>
</div>
</div>
</body>
</html>
