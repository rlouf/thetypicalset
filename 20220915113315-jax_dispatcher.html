<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-12-21 Wed 21:11 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JAX dispatcher</title>
<meta name="author" content="RÃ©mi Louf" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="style.css" /><script data-goatcounter="https://thetypicalset.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">JAX dispatcher</h1>

<div id="outline-container-org55431ef" class="outline-2">
<h2 id="org55431ef">Static arguments</h2>
<div class="outline-text-2" id="text-org55431ef">
</div>
<div id="outline-container-orgfe8c975" class="outline-3">
<h3 id="orgfe8c975">Where they are needed</h3>
<div class="outline-text-3" id="text-orgfe8c975">
<ul class="org-ul">
<li><code>shape</code> parameters</li>
<li>Scan's <code>length</code> parameter</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org20f486e" class="outline-2">
<h2 id="org20f486e">Hashable static arguments to JIT compiled function</h2>
<div class="outline-text-2" id="text-org20f486e">
<p>
i.e. no list, numpy array.
</p>
</div>
</div>

<div id="outline-container-org9738ba9" class="outline-2">
<h2 id="org9738ba9">TypeError: Shape</h2>
<div class="outline-text-2" id="text-org9738ba9">
<p>
Related issues:
</p>
<ul class="org-ul">
<li><a target='_blank' rel='noopener noreferrer' class='external' href="https://github.com/aesara-devs/aesara/issues/702">https://github.com/aesara-devs/aesara/issues/702</a></li>
</ul>


<p>
There are two underlying issues:
</p>
<ul class="org-ul">
<li>JAX needs shapes to be determined at tracing time.</li>
<li><p>
Random variables need size specified as tuples (see <a target='_blank' rel='noopener noreferrer' class='external' href="https://jax.readthedocs.io/en/latest/_autosummary/jax.random.dirichlet.html#jax.random.dirichlet">docstring of the dirichlet distribution</a>)
</p>

<p>
Let's reproduce the example exactly:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> jax

<span style="color: #DFAF8F;">shape</span> = jax.numpy.array([1000])

<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">jax_funcified</span>(prng_key):
    <span style="color: #F0DFAF; font-weight: bold;">return</span> jax.random.normal(prng_key, shape)

<span style="color: #DFAF8F;">key</span> = jax.random.PRNGKey(0)
<span style="color: #F0DFAF; font-weight: bold;">try</span>:
    jax.jit(jax_funcified)(key)
<span style="color: #F0DFAF; font-weight: bold;">except</span> <span style="color: #7CB8BB;">Exception</span> <span style="color: #F0DFAF; font-weight: bold;">as</span> e:
    <span style="color: #F0DFAF; font-weight: bold;">print</span>(e)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> jax
<span style="color: #F0DFAF; font-weight: bold;">import</span> numpy <span style="color: #F0DFAF; font-weight: bold;">as</span> np

<span style="color: #DFAF8F;">shape</span> = np.array([10])

<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">jax_funcified</span>(prng_key):
    <span style="color: #F0DFAF; font-weight: bold;">return</span> jax.random.normal(prng_key, shape)

<span style="color: #DFAF8F;">key</span> = jax.random.PRNGKey(0)
<span style="color: #F0DFAF; font-weight: bold;">print</span>(jax.jit(jax_funcified)(key))
</pre>
</div></li>
</ul>



<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> jax
<span style="color: #F0DFAF; font-weight: bold;">import</span> numpy <span style="color: #F0DFAF; font-weight: bold;">as</span> np

<span style="color: #DFAF8F;">rng_key</span> = jax.random.PRNGKey(0)
<span style="color: #F0DFAF; font-weight: bold;">try</span>:
    <span style="color: #F0DFAF; font-weight: bold;">print</span>(jax.random.normal(rng_key, shape=10))
<span style="color: #F0DFAF; font-weight: bold;">except</span> <span style="color: #7CB8BB;">Exception</span> <span style="color: #F0DFAF; font-weight: bold;">as</span> e:
    <span style="color: #F0DFAF; font-weight: bold;">print</span>(e)
<span style="color: #F0DFAF; font-weight: bold;">print</span>(jax.random.normal(rng_key, shape=[3]))
<span style="color: #F0DFAF; font-weight: bold;">print</span>(jax.random.normal(rng_key, shape=(3,)))
<span style="color: #F0DFAF; font-weight: bold;">print</span>(jax.random.normal(rng_key, shape=np.array([3])))
<span style="color: #F0DFAF; font-weight: bold;">print</span>(jax.random.normal(rng_key, shape=jax.numpy.array([3])))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> jax

<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">fun</span>(x):
    <span style="color: #DFAF8F;">rng_key</span> = jax.random.PRNGKey(0)
    <span style="color: #F0DFAF; font-weight: bold;">return</span> jax.random.normal(rng_key, shape=x)

<span style="color: #F0DFAF; font-weight: bold;">try</span>:
    jax.jit(fun)(1)
<span style="color: #F0DFAF; font-weight: bold;">except</span> <span style="color: #7CB8BB;">Exception</span> <span style="color: #F0DFAF; font-weight: bold;">as</span> e:
    <span style="color: #F0DFAF; font-weight: bold;">print</span>(f<span style="color: #CC9393;">"shape as int: {e}"</span>)

<span style="color: #F0DFAF; font-weight: bold;">try</span>:
    jax.jit(fun)([1, 2])
<span style="color: #F0DFAF; font-weight: bold;">except</span> <span style="color: #7CB8BB;">Exception</span> <span style="color: #F0DFAF; font-weight: bold;">as</span> e:
    <span style="color: #F0DFAF; font-weight: bold;">print</span>(f<span style="color: #CC9393;">"shape as list: {e}"</span>)

<span style="color: #F0DFAF; font-weight: bold;">try</span>:
    jax.jit(fun)((1, 2))
<span style="color: #F0DFAF; font-weight: bold;">except</span> <span style="color: #7CB8BB;">Exception</span> <span style="color: #F0DFAF; font-weight: bold;">as</span> e:
    <span style="color: #F0DFAF; font-weight: bold;">print</span>(f<span style="color: #CC9393;">"shape as tuple: {e}"</span>)

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">using static_argnums</span>
<span style="color: #DFAF8F;">res</span> = jax.jit(fun, static_argnums=(0,))((1, 2))
<span style="color: #F0DFAF; font-weight: bold;">print</span>(f<span style="color: #CC9393;">"shape as tuple (static argnum): {res}"</span>)

<span style="color: #F0DFAF; font-weight: bold;">try</span>:
    <span style="color: #DFAF8F;">res</span> = jax.jit(fun, static_argnums=(0,))([1, 2])
<span style="color: #F0DFAF; font-weight: bold;">except</span> <span style="color: #7CB8BB;">Exception</span> <span style="color: #F0DFAF; font-weight: bold;">as</span> e:
    <span style="color: #F0DFAF; font-weight: bold;">print</span>(f<span style="color: #CC9393;">"shape as list (static_argnums): {e}"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org36d7145" class="outline-2">
<h2 id="org36d7145">Links to this note</h2>
<div class="outline-text-2" id="text-org36d7145">
<ul class="org-ul">
<li><a href="./20220729163627-aesara.html">Aesara</a></li>
</ul>
</div>
</div>
</div>
</body>
</html>