<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-02-02 Thu 11:59 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Measures in AePPL</title>
<meta name="author" content="RÃ©mi Louf" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="style.css" /><script data-goatcounter="https://thetypicalset.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Measures in AePPL</h1>
<p>
<a href="20220824141859-aeppl.html#ID-e18d689a-392a-407a-941a-f0ad2d2dc43e">AePPL</a> needs the notion of measure to be able to perform operations such as <code>truncate</code>, or for more exotic use cases such as distributions defined on a non-trivial manifold. We will note \(\mathbb{M} \mathcal{M}\) the measure defined on the manifold \(\mathcal{M}\) (often \(\mathbb{R}\), but not necessarily). For instance the parametrized \(\operatorname{normal}\) measure (distribution) is defined as:
</p>

<p>
\[
\frac{\mu : \mathbb{R}, \sigma : \mathbb{R}^+}{\operatorname{normal}(\mu, \sigma) \in \mathbb{M}\mathbb{R}}
\]
</p>

<p>
And the \(\operatorname{dirichlet}\) measure as:
</p>

<p>
\[
\frac{\boldsymbol{\alpha} : \mathbb{R}^n}{\operatorname{dirichlet}(\boldsymbol{\alpha}) \in \mathbb{M}\Delta_n}
\]
</p>

<p>
We note \(\mathbb{T}A\) a tensor that contains elements of type \(A\). Broadcasting rules apply when parameters of different dimensionalities apply, and the result is a tensor of measures of type \(\mathbb{T}(\mathbb{M}E)\) where \(E\) is the event space's type.
</p>

<p>
To make the junction with Aesara's <code>RandomVariable</code>\s we define the <code>sample</code> operator. \(\operatorname{sample}(k, m)\) is a function that takes a PRNG key \(k \in \Omega\) , a measure \(m : \mathbb{M}E\) and returns an element \(e \in E\). Under the hood, <code>sample</code> finds the <code>RandomVariable</code> that corresponds to a given measure and creates a new apply node by calling the <code>Op</code>.
</p>

<div class="org-src-container">
<pre class="src src-haskell">sample :: PRNGKey -&gt; Measure -&gt; TensorVariable
</pre>
</div>

<div id="outline-container-orgcc368c1" class="outline-2">
<h2 id="orgcc368c1">Base types</h2>
<div class="outline-text-2" id="text-orgcc368c1">
<p>
We must first define the types \(E\) that the event space can take. Our goal is to get a minimum viable example for the normal distributions so will limit ourselves to \(\mathbb{R}\) and \(\mathbb{R}^+\).
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">from</span> aesara.raise_op <span style="color: #F0DFAF; font-weight: bold;">import</span> CheckAndRaise
<span style="color: #F0DFAF; font-weight: bold;">import</span> aesara.tensor <span style="color: #F0DFAF; font-weight: bold;">as</span> at
<span style="color: #F0DFAF; font-weight: bold;">import</span> abc

<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">CheckParameterValue</span>(CheckAndRaise):
    <span style="color: #9FC59F;">"""Implements a parameter value check in a graph."""</span>

    <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__init__</span>(<span style="color: #F0DFAF; font-weight: bold;">self</span>, msg=<span style="color: #CC9393;">""</span>):
        <span style="color: #DCDCCC; font-weight: bold;">super</span>().__init__(<span style="color: #7CB8BB;">TypeError</span>, msg)

    <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__str__</span>(<span style="color: #F0DFAF; font-weight: bold;">self</span>):
        <span style="color: #F0DFAF; font-weight: bold;">return</span> f<span style="color: #CC9393;">"Check{{{self.msg}}}"</span>


<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Domain</span>(abc.ABC)
    <span style="color: #7CB8BB;">@abc.abstractmethod</span>
    <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__call__</span>(<span style="color: #F0DFAF; font-weight: bold;">self</span>, x):
        <span style="color: #F0DFAF; font-weight: bold;">pass</span>

<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Real</span>(Domain):
    <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__call__</span>(<span style="color: #F0DFAF; font-weight: bold;">self</span>, x):
        <span style="color: #F0DFAF; font-weight: bold;">return</span> CheckParameterValue(<span style="color: #CC9393;">"real"</span>)(x, at.isfinite(x))

<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Positive</span>(Domain):
    <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__call__</span>(<span style="color: #F0DFAF; font-weight: bold;">self</span>, x):
        <span style="color: #F0DFAF; font-weight: bold;">return</span> CheckParameterValue(<span style="color: #CC9393;">"x &gt;= 0"</span>)(x, at.geq(x, 0), at.isfinite(x))

<span style="color: #DFAF8F;">reals</span> = Real()
<span style="color: #DFAF8F;">positive</span> = Positive()
</pre>
</div>

<p>
The constraints that characterize the types are represented in the Aesara graph with a <code>CheckParameterValue</code> assertion.
</p>
</div>
</div>

<div id="outline-container-orgd77e535" class="outline-2">
<h2 id="orgd77e535">Measures</h2>
<div class="outline-text-2" id="text-orgd77e535">
<p>
We now define the type for the measure \(\mathbb{M}E\). We include information about the base measure, noting \(\mathbb{L}\) and \(\mathbb{C}\) for the Lebesgue and counting measures respectively.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> aesara.tensor <span style="color: #F0DFAF; font-weight: bold;">as</span> at
<span style="color: #F0DFAF; font-weight: bold;">import</span> abc

<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Measure</span>(abc.ABC):
    <span style="color: #9FC59F;">"""A variable that represents a probability measure."""</span>
    base_measure: Measure

<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">PrimitiveMeasure</span>(<span style="color: #DCDCCC; font-weight: bold;">abs</span>.ABC):
    <span style="color: #9FC59F;">"""A primitive measure"""</span>
    domain: Domain

<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Lebesgue</span>(PrimitiveMeasure):
    <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__init__</span>(<span style="color: #F0DFAF; font-weight: bold;">self</span>, domain: Domain):
        <span style="color: #F0DFAF; font-weight: bold;">self</span>.domain = domain

<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">NormalMeasure</span>(Measure):
    <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__init__</span>(<span style="color: #F0DFAF; font-weight: bold;">self</span>, loc, scale):
        <span style="color: #F0DFAF; font-weight: bold;">self</span>.parameters = {
            <span style="color: #CC9393;">"loc"</span>: reals(loc),
            <span style="color: #CC9393;">"scale"</span>: positive(scale)
        }
        <span style="color: #F0DFAF; font-weight: bold;">self</span>.base_measure = Lebesgue(reals)
        <span style="color: #F0DFAF; font-weight: bold;">self</span>.rv = at.random.normal
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfc6ac6d" class="outline-2">
<h2 id="orgfc6ac6d">Sample</h2>
<div class="outline-text-2" id="text-orgfc6ac6d">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> aesara.random <span style="color: #F0DFAF; font-weight: bold;">as</span> ar
<span style="color: #F0DFAF; font-weight: bold;">from</span> multipledispatch <span style="color: #F0DFAF; font-weight: bold;">import</span> dispatch

<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">sample</span>(rng, measure: Measure):
    <span style="color: #F0DFAF; font-weight: bold;">return</span> measure.rv(rng=rng, **parameters)
</pre>
</div>
</div>
</div>

<div id="outline-container-org639cb0c" class="outline-2">
<h2 id="org639cb0c">Logdensity</h2>
<div class="outline-text-2" id="text-org639cb0c">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> singledispatch

<span style="color: #7CB8BB;">@singledispatch.register</span>
<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">logdensity</span>(m: measure):
    <span style="color: #F0DFAF; font-weight: bold;">raise</span> <span style="color: #7CB8BB;">NotImplementedError</span>(f<span style="color: #CC9393;">"No density associated with the provided {measure}"</span>)


<span style="color: #7CB8BB;">@logdensity.register</span>(NormalMeasure)
<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">normal_logdensity</span>(m: Measure, values):
    (value,) = values
    <span style="color: #DFAF8F;">mu</span>, <span style="color: #DFAF8F;">sigma</span> = m.parameters[<span style="color: #CC9393;">"loc"</span>], m.parameters[<span style="color: #CC9393;">"scale"</span>]
    <span style="color: #DFAF8F;">res</span> = (
        -0.5 * at.<span style="color: #DCDCCC; font-weight: bold;">pow</span>((value - mu) / sigma, 2)
        - at.log(at.sqrt(2.0 * np.pi))
        - at.log(sigma)
    )
    <span style="color: #F0DFAF; font-weight: bold;">return</span> res

</pre>
</div>
</div>
</div>

<div id="outline-container-org52e2d45" class="outline-2">
<h2 id="org52e2d45">Other</h2>
<div class="outline-text-2" id="text-org52e2d45">
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">logdensity</span>(measure, x):
    <span style="color: #F0DFAF; font-weight: bold;">return</span> _logdensity(measure, measure.base_measure, x)

<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">sample</span>(rng_key, measure):

</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> singledispatch


<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Measure</span>(abc.ABC):
    <span style="color: #9FC59F;">"""A variable that represents a probability measure."""</span>




<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Lebesgue</span>(PrimitiveMeasure):

    <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__init__</span>(<span style="color: #F0DFAF; font-weight: bold;">self</span>, domain):
        <span style="color: #F0DFAF; font-weight: bold;">self</span>.domain = domain

<span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">NormalMeasure</span>(Measure):

    <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__init__</span>(<span style="color: #F0DFAF; font-weight: bold;">self</span>, mu, sigma):
        <span style="color: #F0DFAF; font-weight: bold;">self</span>.mu = reals(mu)
        <span style="color: #F0DFAF; font-weight: bold;">self</span>.sigma = positive(sigma)
        <span style="color: #F0DFAF; font-weight: bold;">self</span>.base_measure = Lebesgue(reals)

</pre>
</div>
</div>
</div>

<div id="outline-container-orgd461cac" class="outline-2">
<h2 id="orgd461cac">Links to this note</h2>
</div>
</div>
</body>
</html>