<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-08-30 Tue 21:03 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shape semantics for random variables in Aesara</title>
<meta name="author" content="RÃ©mi Louf" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="../style.css" /><script data-goatcounter="https://thetypicalset.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Shape semantics for random variables in Aesara</h1>
<p>
The shape of random tensors in <a href="../20220729163627-aesara.html#ID-5a5e87b1-558c-43db-ad38-32a073b10351">Aesara</a> is partitioned in semantically different pieces:
</p>
<ul class="org-ul">
<li>The <b>support shape</b> is the shape of one draw from the base distribution;</li>
<li>The <b>batch shape</b> is the number of independent draws we want from the distribution;</li>
<li>The <b>batch shape</b> can be infered using broadcasting rules for the distribution parameters, and broadcasting shapes with the <code>size</code> keyword argument;</li>
<li>The shape of samples is given by <code>sample_shape = batch_shape + support_shape</code></li>
</ul>

<div id="outline-container-org547dfc2" class="outline-2">
<h2 id="org547dfc2">Support shape</h2>
<div class="outline-text-2" id="text-org547dfc2">
<p>
The first distinction we must make is based on the <i>support</i> of the distributions. Simply put, the support of a distribution is the domain over which the probability density (mass) function of the distribution is defined.
</p>

<p>
The length of the <i>support shape</i> is the equal to the dimensionality of the distribution's support.
</p>
<ul class="org-ul">
<li>0 for distributions defined in 1 dimension (normal distribution, etc.)</li>
<li>Vectors (1 dimension)</li>
<li>Matrices (2 dimensions)</li>
</ul>

<p>
<b>The support shape is the shape of one draw.</b>
</p>
</div>

<div id="outline-container-org10846cd" class="outline-3">
<h3 id="org10846cd">Distributions over scalar values</h3>
<div class="outline-text-3" id="text-org10846cd">
<p>
The support of the normal distribution, for instance, is the real line: every sample drawn from that distribution will be a real number. The support of the bernoulli distribution, on the other hand, is the set of integers $\left\{0, 1\right\}. These distributions are <i>scalar distributions</i>, in the sense that their support has 0 dimension (in <i>array</i> terms). Their support shape is <i>always</i> <code>(,)</code>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.normal(0, 1)
<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()

<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample value: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"support shape: {sample.shape}"</span>)
</pre>
</div>

<pre class="example">
sample value: 1.4436909546981256
support shape: ()
</pre>
</div>
</div>

<div id="outline-container-org73d0377" class="outline-3">
<h3 id="org73d0377">Distributions over vectors</h3>
<div class="outline-text-3" id="text-org73d0377">
<p>
Other distributions are defined on more complex spaces. The multivariate normal distribution, for instance, is 1-dimentsional and can be defined for an arbitrary number of components \(k\). In this case the support shape is of length 1 and equal to <code>(k,)</code>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)

<span style="font-weight: bold; font-style: italic;">d</span> = 4
<span style="font-weight: bold; font-style: italic;">mu</span> = np.random.rand(d)
<span style="font-weight: bold; font-style: italic;">sigma</span> = np.eye(d)
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.multivariate_normal(mu, sigma)
<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()

<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample value: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"support shape: {sample.shape}"</span>)
</pre>
</div>

<pre class="example">
sample value: [ 1.98832878 -0.61854378  1.36816224  0.02745684]
support shape: (4,)
</pre>


<p>
We can define a multivariate normal distribution with one component, and for consistency its support shape is equal to <code>(1,)</code>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)

<span style="font-weight: bold; font-style: italic;">mu</span> = np.array([1])
<span style="font-weight: bold; font-style: italic;">sigma</span> = np.eye(1)
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.multivariate_normal(mu, sigma)
<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()

<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample value: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"support shape: {sample.shape}"</span>)
</pre>
</div>

<pre class="example">
sample value: [2.44369095]
support shape: (1,)
</pre>


<p>
Example of distributions with 1-dimensional support: <code>multivariate_normal</code>, <code>categorical</code>, <code>multinomial</code>, <code>dirichlet</code>.
</p>
</div>
</div>

<div id="outline-container-org635c269" class="outline-3">
<h3 id="org635c269">Distributions over matrices, etc.</h3>
<div class="outline-text-3" id="text-org635c269">
<p>
Finally, distributions can be defined on a space with an arbitrary number of dimensions. The <a target='_blank' rel='noopener noreferrer' class='external' href="https://en.wikipedia.org/wiki/Wishart_distribution">Wishart distribution</a> for instance is 2-dimensional: a sample from this distribution is a matrix.
</p>
</div>
</div>
</div>


<div id="outline-container-org06ccb99" class="outline-2">
<h2 id="org06ccb99">Batch shape</h2>
<div class="outline-text-2" id="text-org06ccb99">
<p>
Let us only consider distributions over scalar values for now.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.normal(0, 1)
<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()

<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample value: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample shape: {sample.shape}"</span>)
</pre>
</div>

<pre class="example">
sample value: 1.4436909546981256
sample shape: ()
</pre>


<p>
The <code>batch shape</code> encompasses one reality: the number of independent, identically distributed samples we want to draw from the probability distribution. There are two ways to arrive at the same batch shape:
</p>
<ul class="org-ul">
<li>Setting the shape explicitly;</li>
<li>Broadcasting of parameter arrays.</li>
</ul>
</div>

<div id="outline-container-orgf25edd1" class="outline-3">
<h3 id="orgf25edd1">Batching</h3>
<div class="outline-text-3" id="text-orgf25edd1">
<p>
If we want to take \(3\) independent and indentically distributed samples from this distribution we can use the <code>size</code> keyword argument:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.normal(0, 1, size=(3,))  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">size=3 gives the same result</span>
<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()

<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample value: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample shape: {sample.shape}"</span>)
</pre>
</div>

<pre class="example">
sample value: [ 1.44369095 -0.89594598  0.73595567]
sample shape: (3,)
</pre>


<p>
We can request <i>tensors</i> with independent and identically distributed samples of arbitrary shape:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)
<span style="font-weight: bold; font-style: italic;">batch_shape</span> = (2, 2, 2)
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.normal(0, 1, size=batch_shape)
<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()

<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample value: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample shape: {sample.shape}"</span>)
</pre>
</div>

<pre class="example">
sample value: [[[ 1.44369095 -0.89594598]
  [ 0.73595567  0.00587704]]

 [[ 0.85338179  0.16094803]
  [ 0.81931469  0.80565568]]]
sample shape: (2, 2, 2)
</pre>


<p>
We will say that <code>size</code> explicits the <i>batch shape</i>, which is the shape of the tensor of idependent random variables produced by the op. In this example the random variables are identically distributed, but this need not be the case.
</p>
</div>
</div>

<div id="outline-container-orga6de5b6" class="outline-3">
<h3 id="orga6de5b6">Vectorizing</h3>
<div class="outline-text-3" id="text-orga6de5b6">
<blockquote>
<p>
<b>tldr;</b> Random Variables are `Blockwise` operators
</p>
</blockquote>


<p>
Say we want a sample from three normal distributions with a \(0\), \(3\) and \(5\) mean value respectively. One (cumbersome) way to achieve this is:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream()
<span style="font-weight: bold; font-style: italic;">rv_0</span> = srng.normal(0, 1)
<span style="font-weight: bold; font-style: italic;">rv_3</span> = srng.normal(3, 1)
<span style="font-weight: bold; font-style: italic;">rv_5</span> = srng.normal(5, 1)
<span style="font-weight: bold; font-style: italic;">rv</span> = at.stack([rv_0, rv_3, rv_5])

<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample value: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample shape: {sample.shape}"</span>)
</pre>
</div>

<pre class="example">
sample value: [-0.41520246  1.92093324  6.74827434]
sample shape: (3,)
</pre>


<p>
To simplify this common operation we can use pass arrays as parameters, and the random variable uses common NumPy broadcasting rules.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)

<span style="font-weight: bold; font-style: italic;">mean</span> = np.array([0, 3, 5])
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.normal(mean, 1)

<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample values: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"batch shape: {sample.shape}"</span>)
</pre>
</div>

<pre class="example">
sample value: [1.44369095 2.10405402 5.73595567]
sample shape: (3,)
</pre>


<p>
In this case the <i>batch shape</i> is also  <code>(3,)</code>; it is the shape of the tensor that contains random variables that are independently distributed and whose distribution belong to the same family.
</p>

<p>
We can also use arrays for the standard deviation in this case. Standard broadcasting rules apply to determine the batch shape. For instance, the following fails with a shape mismatch error:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)

<span style="font-weight: bold; font-style: italic;">mean</span> = np.array([0, 3, 5])
<span style="font-weight: bold; font-style: italic;">sigma</span> = np.array([1, 2])
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.normal(mean, sigma)

<span style="font-weight: bold;">try</span>:
    rv.<span style="font-weight: bold;">eval</span>()
<span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">ValueError</span> <span style="font-weight: bold;">as</span> err:
    <span style="font-weight: bold;">print</span>(err)
</pre>
</div>

<pre class="example" id="org54d46eb">
shape mismatch: objects cannot be broadcast to a single shape.  Mismatch is between arg 0 with shape (3,) and arg 1 with shape (2,).
Apply node that caused the error: normal_rv{0, (0, 0), floatX, True}(RandomGeneratorSharedVariable(&lt;Generator(PCG64) at 0x7F8DCB881A80&gt;), TensorConstant{[]}, TensorConstant{11}, TensorConstant{[0 3 5]}, TensorConstant{[1 2]})
Toposort index: 0
Inputs types: [RandomGeneratorType, TensorType(int64, (0,)), TensorType(int64, ()), TensorType(int64, (3,)), TensorType(int64, (2,))]
Inputs shapes: ['No shapes', (0,), (), (3,), (2,)]
Inputs strides: ['No strides', (0,), (), (8,), (8,)]
Inputs values: [Generator(PCG64) at 0x7F8DCB881A80, array([], dtype=int64), array(11), array([0, 3, 5]), array([1, 2])]
Outputs clients: [['output'], ['output']]

HINT: Re-running with most Aesara optimizations disabled could provide a back-trace showing when this node was created. This can be done by setting the Aesara flag 'optimizer=fast_compile'. If that does not work, Aesara optimizations can be disabled with 'optimizer=None'.
HINT: Use the Aesara flag `exception_verbosity=high` for a debug print-out and storage map footprint of this Apply node.
</pre>

<p>
Indeed <code>mean</code> and <code>sigma</code> cannot be broadcast together:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np

<span style="font-weight: bold; font-style: italic;">mean</span> = np.array([0, 3, 5])
<span style="font-weight: bold; font-style: italic;">sigma</span> = np.array([1, 2])
<span style="font-weight: bold;">try</span>:
    np.broadcast(mean, sigma)  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">error</span>
<span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">ValueError</span> <span style="font-weight: bold;">as</span> err:
    <span style="font-weight: bold;">print</span>(err)
</pre>
</div>

<pre class="example">
shape mismatch: objects cannot be broadcast to a single shape.  Mismatch is between arg 0 with shape (3,) and arg 1 with shape (2,).
</pre>


<p>
<code>np.broadcast(mean, sigma)</code> gives us the batch shape:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np

<span style="font-weight: bold; font-style: italic;">mean</span> = np.array([0, 3, 5])
<span style="font-weight: bold; font-style: italic;">sigma</span> = np.array([1, 2, 7])
<span style="font-weight: bold;">print</span>(np.broadcast(mean, sigma).shape)
</pre>
</div>

<pre class="example">
(3,)
</pre>


<p>
Indeed:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)

<span style="font-weight: bold; font-style: italic;">mean</span> = np.array([0, 3, 5])
<span style="font-weight: bold; font-style: italic;">sigma</span> = np.array([1, 2, 3])
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.normal(mean, sigma)

<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample values: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"batch shape: {sample.shape}"</span>)
</pre>
</div>

<pre class="example">
sample values: [1.44369095 1.20810805 7.20786701]
batch shape: (3,)
</pre>


<blockquote>
<p>
Broadcasting rules can be a bit obscure for distributions, since the operations they are performing to draw samples or compute the value of the log-probability density (mass) function are unknown.
</p>

<p>
We should specify these broadcasting rules as `gufunc` signatures in the docstrings.
</p>
</blockquote>
</div>
</div>


<div id="outline-container-org47999cf" class="outline-3">
<h3 id="org47999cf">Vectorizing + Batching</h3>
<div class="outline-text-3" id="text-org47999cf">
<p>
It is possible to vectorize and batch at the same time. Note that <code>size</code> and that vectorized shape must be broadcastable
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)

<span style="font-weight: bold; font-style: italic;">mean</span> = np.array([0, 3, 5])
<span style="font-weight: bold; font-style: italic;">sigma</span> = np.array([1, 2, 3])
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.normal(mean, sigma, size=(2, 2, 3))

<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample values: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"batch shape: {sample.shape}"</span>)
</pre>
</div>

<pre class="example">
sample values: [[[1.44369095e+00 1.20810805e+00 7.20786701e+00]
  [5.87704041e-03 4.70676358e+00 5.48284410e+00]]

 [[8.19314690e-01 4.61131137e+00 5.65270195e+00]
  [9.70078743e-01 1.52177388e+00 6.78043377e+00]]]
batch shape: (2, 2, 3)
</pre>


<p>
where <code>np.broadcast(mean, sigma).shape</code> must correspond to the last dimensions of <code>size</code>. Or in other words, the sample shape is <code>np.broadcast_shapes(np.broadcast(mean, sigma).shape, size)</code> if this does not raise an error.
</p>

<p>
It IS really simple:
</p>

<p>
<code>sample_shape = np.broadcast_shapes(np.broadcast(*args), size)</code>
</p>
</div>
</div>
</div>


<div id="outline-container-org654984e" class="outline-2">
<h2 id="org654984e">All together</h2>
<div class="outline-text-2" id="text-org654984e">
<p>
Same thing, <code>size</code> defines the batch shape, and <code>aesara</code> will raise an exception if this is not correctly set.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np

<span style="font-weight: bold; font-style: italic;">n</span> = np.array([10, 9])
<span style="font-weight: bold; font-style: italic;">p</span> = np.array([[.8, .1, .1], [.4, .1, .5]])

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.multinomial(n, p, size=(3, 2))

<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample value: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample shape: {sample.shape}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"support shape: {sample.shape[-1:]}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"batch shape: {sample.shape[:-1]}"</span>)
</pre>
</div>

<pre class="example" id="org571a7d9">
sample value: [[[6 2 2]
  [4 0 5]]

 [[8 1 1]
  [1 2 6]]

 [[9 0 1]
  [5 0 4]]]
sample shape: (3, 2, 3)
support shape: (3,)
batch shape: (3, 2)
</pre>
</div>

<div id="outline-container-org4bc7911" class="outline-3">
<h3 id="org4bc7911">Broadcasting</h3>
<div class="outline-text-3" id="text-org4bc7911">
<p>
When we broadcast the parameters of a non-scalar distribution, two things need to be defined:
</p>
<ol class="org-ol">
<li>The support shape</li>
<li>The batch shape</li>
</ol>

<p>
In the case of the multinomial distribution, the size of the last dimension of \(p\) determines the support shape. Then the formula applies:
</p>

<p>
<code>sample_shape = batch_shape + support_shape</code>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np

<span style="font-weight: bold; font-style: italic;">n</span> = np.array([10, 9])
<span style="font-weight: bold; font-style: italic;">p</span> = np.array([[.8, .1, .1], [.4, .1, .5]])

<span style="font-weight: bold; font-style: italic;">srng</span> = at.random.RandomStream(0)
<span style="font-weight: bold; font-style: italic;">rv</span> = srng.multinomial(n, p)

<span style="font-weight: bold; font-style: italic;">sample</span> = rv.<span style="font-weight: bold;">eval</span>()
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample value: {sample}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"sample shape: {sample.shape}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"support shape: {sample.shape[-1:]}"</span>)
<span style="font-weight: bold;">print</span>(f<span style="font-style: italic;">"batch shape: {sample.shape[0]}"</span>)
</pre>
</div>

<pre class="example">
sample value: [[6 2 2]
 [4 0 5]]
sample shape: (2, 3)
support shape: (3,)
batch shape: 2
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
