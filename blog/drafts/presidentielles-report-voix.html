<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-06-15 Wed 15:59 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estimer le report des voix aux présidentielles</title>
<meta name="author" content="Rémi Louf" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="style.css" /><script data-goatcounter="https://thetypicalset.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Estimer le report des voix aux présidentielles</h1>
<p>
Cet article fait suite au <a target='_blank' rel='noopener noreferrer' class='external' href="https://github.com/laurentperrinet/2022-05-04_transfert-des-voix/blob/main/2022-06-08_transfert-des-voix.ipynb">travail de Laurent Perrinet</a> sur les reports de voix entre le premier et le deuxième tour des élections présidentielles en 2022. La démarche de ce travail est intéressante (et autant que je sache originale) : elle consiste à prendre les résultats des élections au niveau des bureaux de vote aux deux tours, et essayer d'estimer une matrice de transition i.e. la probabilité que quelqu'un ayant voté pour X (par exemple Fabien Roussel) vote pour Y (par exemple Marine Le Pen) au second tour.
</p>

<p>
Le modèle utilisé est déterministe. Il est implémenté avec PyTorch:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> torch
<span style="font-weight: bold;">from</span> torch.utils.data <span style="font-weight: bold;">import</span> TensorDataset, DataLoader, random_split
<span style="font-weight: bold;">import</span> torch.nn.functional <span style="font-weight: bold;">as</span> F

torch.set_default_tensor_type(<span style="font-style: italic;">"torch.FloatTensor"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TransfertVoix</span>(torch.nn.Module):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, N_1er, N_2eme):<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">, device=None):</span>
        <span style="font-weight: bold;">super</span>(TransfertVoix, <span style="font-weight: bold;">self</span>).__init__()
        <span style="font-weight: bold;">self</span>.lin = torch.nn.Linear(N_2eme, N_1er, bias=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">forward</span>(<span style="font-weight: bold;">self</span>, p_1):
        <span style="font-weight: bold; font-style: italic;">M</span> = torch.softmax(<span style="font-weight: bold;">self</span>.lin.weight, axis=1)
        <span style="font-weight: bold; font-style: italic;">p_2_pred</span> = torch.matmul(p_1, M)
        <span style="font-weight: bold;">return</span> p_2_pred
</pre>
</div>

<p>
A première lecture des résultats et au vu du modèle ci-dessus plusieurs pistes d'amélioration me viennent en tête:
</p>
<ol class="org-ol">
<li>L'auteur montre les corrélations entre le vote Mélenchon au premier tour, et celui de Macron au second tour. Les distributions marginales sont très étalées. Je m'attend à une variabilité encore plus grande pour les candidats avec un score moindre. Cette variabilité peut avoir un effet non-négligeable sur les résultats; je suis par exemple surpris des forts reports vers Le Pen calculés pour Arthaud, Poutou et Roussel. Ce n'est pas à exclure, certes, mais je pense que l'on bénéficierait d'une approche bayésienne et bénéficier d'une marge d'erreur sur ces résultats;</li>
<li>L'hypothèse d'un report uniforme sur tout le territoire me parait également osée. On devrait envisager un modèle hiérarchique;</li>
<li>Les sondages de sortie d'urne peuvent servir pour définir le prior (hyperprior dans le cas d'un modèle hiérarchique).</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> os
<span style="font-weight: bold;">import</span> numpy <span style="font-weight: bold;">as</span> np
<span style="font-weight: bold;">import</span> pandas <span style="font-weight: bold;">as</span> pd
</pre>
</div>

<div id="outline-container-org80e0a03" class="outline-2">
<h2 id="org80e0a03">Les données</h2>
<div class="outline-text-2" id="text-org80e0a03">
<p>
On se placera ici à l'échelle de la circonscription législative. Le découpage à l'échelle du bureau de vote est intéressant, mais le but implicite de cette étude est de donner une idée des reports de voix pour le second tour des législatives 2022. J'utilise ici le code de <a target='_blank' rel='noopener noreferrer' class='external' href="https://github.com/laurentperrinet/2022-05-04_transfert-des-voix/blob/main/2022-06-08_transfert-des-voix.ipynb">Laurent Perrinet</a> en le modifiant (les erreurs éventuelles sont de mon fait).
</p>
</div>

<div id="outline-container-org222aa07" class="outline-3">
<h3 id="org222aa07">Premier tour</h3>
<div class="outline-text-3" id="text-org222aa07">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">fname</span> = <span style="font-style: italic;">'/tmp/T1.xlsx'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> os.path.isfile(fname):
    <span style="font-weight: bold; font-style: italic;">url</span> = <span style="font-style: italic;">"https://www.data.gouv.fr/fr/datasets/r/1a35594a-99f2-4257-87e0-ec2f55039276"</span>
    <span style="font-weight: bold;">import</span> urllib.request
    urllib.request.urlretrieve(url, fname)

<span style="font-weight: bold; font-style: italic;">T1</span> = pd.read_excel(fname)
</pre>
</div>


<div class="org-src-container">
<pre class="src src-python">T1.tail()
</pre>
</div>

<pre class="example">
    Code du département           Libellé du département  Code de la circonscription Libellé de la circonscription Etat saisie  ...    Unnamed: 98  Unnamed: 99  Unnamed: 100  Unnamed: 101  Unnamed: 102
572                  ZZ  Français établis hors de France                           7          7ème circonscription     Complet  ...  DUPONT-AIGNAN      Nicolas           639          0.52          1.23
573                  ZZ  Français établis hors de France                           8          8ème circonscription     Complet  ...  DUPONT-AIGNAN      Nicolas           300          0.23          1.28
574                  ZZ  Français établis hors de France                           9          9ème circonscription     Complet  ...  DUPONT-AIGNAN      Nicolas           381          0.31          0.97
575                  ZZ  Français établis hors de France                          10         10ème circonscription     Complet  ...  DUPONT-AIGNAN      Nicolas           530          0.51          1.33
576                  ZZ  Français établis hors de France                          11         11ème circonscription     Complet  ...  DUPONT-AIGNAN      Nicolas           595          0.60          1.58

[5 rows x 103 columns]
</pre>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">df_1</span> = T1[[<span style="font-style: italic;">'Nuls'</span>, <span style="font-style: italic;">'Blancs'</span>, <span style="font-style: italic;">'Abstentions'</span>]].copy()
<span style="font-weight: bold; font-style: italic;">df_1</span>[<span style="font-style: italic;">"Non exprim&#233;s"</span>] =  df_1[<span style="font-style: italic;">'Nuls'</span>] + df_1[<span style="font-style: italic;">'Blancs'</span>] + df_1[<span style="font-style: italic;">'Abstentions'</span>]
<span style="font-weight: bold; font-style: italic;">df_1</span> = df_1[[<span style="font-style: italic;">"Non exprim&#233;s"</span>]].copy()
<span style="font-weight: bold; font-style: italic;">T1</span>[<span style="font-style: italic;">'Code de la circonscription'</span>] = T1[<span style="font-style: italic;">'Code de la circonscription'</span>].<span style="font-weight: bold;">apply</span>(<span style="font-weight: bold;">str</span>)
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">df_1['circonscription'] = T1['Code du d&#233;partement'] + T1['Code de la circonscription']</span>
df_1.head()
</pre>
</div>

<pre class="example">
   Non exprimés
0         20139
1         21636
2         21581
3         21599
4         20130
</pre>



<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">col_start</span> = 21
<span style="font-weight: bold; font-style: italic;">col_par_cdt</span> = 7
<span style="font-weight: bold; font-style: italic;">candidats</span> = T1.iloc[0][col_start::col_par_cdt]

<span style="font-weight: bold;">for</span> i_candidat, candidat <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">enumerate</span>(candidats):
    <span style="font-weight: bold; font-style: italic;">i_col</span> = col_start + i_candidat*col_par_cdt + 2
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'# colonne'</span>, i_col, <span style="font-style: italic;">' r&#233;sultats='</span>, T1.iloc[:, i_col].values)
    <span style="font-weight: bold; font-style: italic;">df_1</span>[candidat] = T1.iloc[:, i_col].values
</pre>
</div>


<p>
Let's check the results by plotting the distribution of votes:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> matplotlib.pyplot <span style="font-weight: bold;">as</span> plt

<span style="font-weight: bold; font-style: italic;">fig</span>, <span style="font-weight: bold; font-style: italic;">ax</span> = plt.subplots(figsize=(13, 5))
<span style="font-weight: bold; font-style: italic;">k</span> = df_1.<span style="font-weight: bold;">sum</span>()/df_1.<span style="font-weight: bold;">sum</span>().<span style="font-weight: bold;">sum</span>()
<span style="font-weight: bold; font-style: italic;">ax</span> = k.plot.bar(ax=ax)
ax.set_xlabel(<span style="font-style: italic;">'Choix 1er tour'</span>)
ax.set_ylabel(<span style="font-style: italic;">'Pourcentage'</span>);
plt.savefig(filename, bbox_inches=<span style="font-style: italic;">"tight"</span>)
filename
</pre>
</div>



<div id="org1f54a0c" class="figure">
<p><img src="file:///tmp/babel-XyHH31/figureFbqdwF.png" alt="figureFbqdwF.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org09dfc38" class="outline-3">
<h3 id="org09dfc38">Deuxième tour</h3>
<div class="outline-text-3" id="text-org09dfc38">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">fname</span> = <span style="font-style: italic;">'/tmp/T2.xlsx'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> os.path.isfile(fname):
    <span style="font-weight: bold; font-style: italic;">url</span> = <span style="font-style: italic;">"https://www.data.gouv.fr/fr/datasets/r/5eacdbc7-b1a2-440c-8eef-09c8bfb87609"</span>
    <span style="font-weight: bold;">import</span> urllib.request
    urllib.request.urlretrieve(url, fname)

<span style="font-weight: bold; font-style: italic;">T2</span> = pd.read_excel(fname)
</pre>
</div>


<div class="org-src-container">
<pre class="src src-python">T2.tail()
</pre>
</div>

<pre class="example">
    Code du département           Libellé du département  Code de la circonscription Libellé de la circonscription Etat saisie  Inscrits  ...  Unnamed: 27  Unnamed: 28  Unnamed: 29  Unnamed: 30  Unnamed: 31  Unnamed: 32
572                  ZZ  Français établis hors de France                           7          7ème circonscription     Complet    122145  ...            F       LE PEN       Marine         4987         4.08         8.58
573                  ZZ  Français établis hors de France                           8          8ème circonscription     Complet    130068  ...            F       LE PEN       Marine         3345         2.57        14.02
574                  ZZ  Français établis hors de France                           9          9ème circonscription     Complet    121013  ...            F       LE PEN       Marine         4988         4.12        13.28
575                  ZZ  Français établis hors de France                          10         10ème circonscription     Complet    104829  ...            F       LE PEN       Marine         8085         7.71        20.39
576                  ZZ  Français établis hors de France                          11         11ème circonscription     Complet     98707  ...            F       LE PEN       Marine         7246         7.34        18.88

[5 rows x 33 columns]
</pre>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">df_2</span> = T2[[<span style="font-style: italic;">'Nuls'</span>, <span style="font-style: italic;">'Blancs'</span>, <span style="font-style: italic;">'Abstentions'</span>]].copy()
<span style="font-weight: bold; font-style: italic;">df_2</span>[<span style="font-style: italic;">"Non exprim&#233;s"</span>] =  df_2[<span style="font-style: italic;">'Nuls'</span>] + df_2[<span style="font-style: italic;">'Blancs'</span>] + df_2[<span style="font-style: italic;">'Abstentions'</span>]
<span style="font-weight: bold; font-style: italic;">df_2</span> = df_2[[<span style="font-style: italic;">"Non exprim&#233;s"</span>]].copy()
<span style="font-weight: bold; font-style: italic;">T2</span>[<span style="font-style: italic;">'Code de la circonscription'</span>] = T2[<span style="font-style: italic;">'Code de la circonscription'</span>].<span style="font-weight: bold;">apply</span>(<span style="font-weight: bold;">str</span>)
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">df_1['circonscription'] = T1['Code du d&#233;partement'] + T1['Code de la circonscription']</span>
df_2.head()
</pre>
</div>

<pre class="example">
   Non exprimés
0         25547
1         28855
2         27496
3         27276
4         26071
</pre>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">col_start</span> = 21
<span style="font-weight: bold; font-style: italic;">col_par_cdt</span> = 7
<span style="font-weight: bold; font-style: italic;">candidats</span> = T2.iloc[0][col_start::col_par_cdt]

<span style="font-weight: bold;">for</span> i_candidat, candidat <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">enumerate</span>(candidats):
    <span style="font-weight: bold; font-style: italic;">i_col</span> = col_start + i_candidat*col_par_cdt + 2
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'# colonne'</span>, i_col, <span style="font-style: italic;">' r&#233;sultats='</span>, T2.iloc[:, i_col].values)
    <span style="font-weight: bold; font-style: italic;">df_2</span>[candidat] = T2.iloc[:, i_col].values
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">fig</span>, <span style="font-weight: bold; font-style: italic;">ax</span> = plt.subplots(figsize=(13, 5))
<span style="font-weight: bold; font-style: italic;">k</span> = df_2.<span style="font-weight: bold;">sum</span>()/df_2.<span style="font-weight: bold;">sum</span>().<span style="font-weight: bold;">sum</span>()
<span style="font-weight: bold; font-style: italic;">ax</span> = k.plot.bar(ax=ax)
ax.set_xlabel(<span style="font-style: italic;">'Candidat'</span>)
ax.set_ylabel(<span style="font-style: italic;">'pourcentage'</span>);
plt.savefig(filename, bbox_inches=<span style="font-style: italic;">"tight"</span>)
filename
</pre>
</div>


<div id="orgd2a2ef2" class="figure">
<p><img src="file:///tmp/babel-XyHH31/figuremqqV6A.png" alt="figuremqqV6A.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgb7440ad" class="outline-3">
<h3 id="orgb7440ad">Second order</h3>
<div class="outline-text-3" id="text-orgb7440ad">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> seaborn <span style="font-weight: bold;">as</span> sns

<span style="font-weight: bold; font-style: italic;">CDT_1</span> = <span style="font-style: italic;">"M&#201;LENCHON"</span>
<span style="font-weight: bold; font-style: italic;">CDT_2</span> = <span style="font-style: italic;">"LE PEN"</span>

<span style="font-weight: bold; font-style: italic;">df_12</span> = pd.DataFrame()
<span style="font-weight: bold; font-style: italic;">df_12</span>[CDT_1] = df_1[CDT_1].copy()
<span style="font-weight: bold; font-style: italic;">df_12</span>[CDT_2] = df_2[CDT_2].copy()

<span style="font-weight: bold; font-style: italic;">df_12</span>[CDT_1] = df_12[CDT_1]/df_1.<span style="font-weight: bold;">sum</span>(axis=1)
<span style="font-weight: bold; font-style: italic;">df_12</span>[CDT_2] = df_12[CDT_2]/df_2.<span style="font-weight: bold;">sum</span>(axis=1)

<span style="font-weight: bold; font-style: italic;">fig</span> = plt.figure()
sns.jointplot(x=df_12[CDT_1], y=df_12[CDT_2], kind=<span style="font-style: italic;">'hist'</span>, height=8);
plt.savefig(filename)
filename
</pre>
</div>


<div id="orgd49531f" class="figure">
<p><img src="file:///tmp/babel-XyHH31/figureMfdkeO.png" alt="figureMfdkeO.png" />
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org4d635ef" class="outline-2">
<h2 id="org4d635ef">Simple modèle écologique</h2>
<div class="outline-text-2" id="text-org4d635ef">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">second</span> = df_2[1:].values[:577, :]
<span style="font-weight: bold; font-style: italic;">premier</span> = df_1[1:].values[:577:]
<span style="font-weight: bold; font-style: italic;">n_premier</span> = premier.shape[1]
<span style="font-weight: bold; font-style: italic;">n_second</span> = second.shape[1]
<span style="font-weight: bold; font-style: italic;">n_circos</span> = premier.shape[0]
</pre>
</div>

<p>
The model we implement is taken from <a target='_blank' rel='noopener noreferrer' class='external' href="https://gking.harvard.edu/files/em.pdf">this paper.</a> We will be using <code>aesara</code> for modelling and <code>blackjax</code> for sampling.
</p>
</div>

<div id="outline-container-org7c8c401" class="outline-3">
<h3 id="org7c8c401">Simplified version (full mixing of the transition matrix)</h3>
<div class="outline-text-3" id="text-org7c8c401">
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at
<span style="font-weight: bold;">from</span> aesara.tensor.random <span style="font-weight: bold;">import</span> RandomStream

<span style="font-weight: bold; font-style: italic;">srng</span> = RandomStream(0)

<span style="font-weight: bold; font-style: italic;">p1_at</span> = at.as_tensor(premier / premier.<span style="font-weight: bold;">sum</span>(axis=1).reshape((premier.shape[0], 1)))
<span style="font-weight: bold; font-style: italic;">beta_rv</span> = srng.dirichlet(at.ones((n_premier, n_second)))
<span style="font-weight: bold; font-style: italic;">p2_at</span> = at.dot(p1_at, beta_rv)
<span style="font-weight: bold; font-style: italic;">p2_at_norm</span> = p2_at / p2_at.<span style="font-weight: bold;">sum</span>(axis=1).reshape((p2_at.shape[0], 1))
<span style="font-weight: bold; font-style: italic;">R2_rv</span> = srng.multinomial(at.<span style="font-weight: bold;">sum</span>(second, axis=1), p2_at_norm)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">R2_vv</span> = R2_rv.clone()
<span style="font-weight: bold; font-style: italic;">beta_vv</span> = beta_rv.clone()

<span style="font-weight: bold; font-style: italic;">transforms_op</span> = TransformValuesOpt(
     {beta_vv: SimplexTransform()}
)
<span style="font-weight: bold; font-style: italic;">logprob</span> = joint_logprob(
    {R2_rv: R2_vv, beta_rv: beta_vv},
    extra_rewrites=transforms_op
)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Compile the logprob function</span>
<span style="font-weight: bold; font-style: italic;">logprob_fn</span> = aesara.function((beta_vv, R2_vv), logprob)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">beta</span> = SimplexTransform().forward(beta_rv).<span style="font-weight: bold;">eval</span>()
<span style="font-weight: bold;">print</span>(logprob_fn(beta, second))
</pre>
</div>

<pre class="example">
-6529676.145333376
</pre>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> aesara.link.jax.dispatch <span style="font-weight: bold;">import</span> jax_funcify
<span style="font-weight: bold;">from</span> aesara.graph.fg <span style="font-weight: bold;">import</span> FunctionGraph
<span style="font-weight: bold;">from</span> aeppl.opt <span style="font-weight: bold;">import</span> logprob_rewrites_db
<span style="font-weight: bold;">from</span> aesara.<span style="font-weight: bold;">compile</span> <span style="font-weight: bold;">import</span> mode
<span style="font-weight: bold;">from</span> aesara.raise_op <span style="font-weight: bold;">import</span> CheckAndRaise

<span style="font-weight: bold; text-decoration: underline;">@jax_funcify.register</span>(CheckAndRaise)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">jax_funcify_Assert</span>(op, **kwargs):
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Jax does not allow assert whose values aren't known during JIT compilation</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">within it's JIT-ed code. Hence we need to make a simple pass through</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">version of the Assert Op.</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">https://github.com/google/jax/issues/2273#issuecomment-589098722</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">assert_fn</span>(value, *inps):
        <span style="font-weight: bold;">return</span> value

    <span style="font-weight: bold;">return</span> assert_fn

<span style="font-weight: bold; font-style: italic;">fgraph</span> = FunctionGraph(inputs=(beta_vv, R2_vv), outputs=(logprob,))
mode.JAX.optimizer.optimize(fgraph)
<span style="font-weight: bold; font-style: italic;">jax_fn</span> = jax_funcify(fgraph)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">M</span> = SimplexTransform().forward(beta_rv).<span style="font-weight: bold;">eval</span>()
<span style="font-weight: bold;">print</span>(jax_fn(M, second)[0])
</pre>
</div>

<pre class="example">
-2310109.667225258
</pre>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">logpdf</span>(beta):
    <span style="font-weight: bold;">return</span> jax_fn(beta, second)[0]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> jax
<span style="font-weight: bold;">import</span> blackjax


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">inference_loop</span>(rng_key, kernel, initial_state, num_samples):
    <span style="font-style: italic;">"""Sequantially draws samples given the kernel of choice."""</span>

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">one_step</span>(state, rng_key):
        <span style="font-weight: bold; font-style: italic;">state</span>, <span style="font-weight: bold; font-style: italic;">_</span> = kernel(rng_key, state)
        <span style="font-weight: bold;">return</span> state, state

    <span style="font-weight: bold; font-style: italic;">keys</span> = jax.random.split(rng_key, num_samples)
    <span style="font-weight: bold; font-style: italic;">_</span>, <span style="font-weight: bold; font-style: italic;">states</span> = jax.lax.scan(one_step, initial_state, keys)

    <span style="font-weight: bold;">return</span> states


<span style="font-weight: bold; font-style: italic;">rng</span> = jax.random.PRNGKey(0)
<span style="font-weight: bold; font-style: italic;">adapt</span> = blackjax.window_adaptation(blackjax.nuts, logpdf, 5000, initial_step_size=1., target_acceptance_rate=0.8)
<span style="font-weight: bold; font-style: italic;">state</span>, <span style="font-weight: bold; font-style: italic;">kernel</span>, <span style="font-weight: bold; font-style: italic;">_</span> = adapt.run(rng, M)
<span style="font-weight: bold; font-style: italic;">samples</span> = inference_loop(rng, kernel, state, 1000)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">trans_at</span> = at.matrix()
<span style="font-weight: bold; font-style: italic;">untrans_at</span> = SimplexTransform().backward(trans_at)

<span style="font-weight: bold; font-style: italic;">fgraph</span> = FunctionGraph(inputs=(trans_at,), outputs=(untrans_at,))
mode.JAX.optimizer.optimize(fgraph)
<span style="font-weight: bold; font-style: italic;">untransform_fn</span> = jax_funcify(fgraph)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">a</span> = jax.vmap(untransform_fn, in_axes=(0))(samples.position)[0]
jnp.mean(a, axis=0)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">0.878626471</td>
<td class="org-right">0.0258810833</td>
<td class="org-right">0.0954924455</td>
</tr>

<tr>
<td class="org-right">0.000209201952</td>
<td class="org-right">0.000168469037</td>
<td class="org-right">0.999622329</td>
</tr>

<tr>
<td class="org-right">0.353824482</td>
<td class="org-right">0.000729045323</td>
<td class="org-right">0.645446473</td>
</tr>

<tr>
<td class="org-right">1.2244228e-05</td>
<td class="org-right">0.999982977</td>
<td class="org-right">4.77903114e-06</td>
</tr>

<tr>
<td class="org-right">0.456462577</td>
<td class="org-right">9.27429875e-05</td>
<td class="org-right">0.54344468</td>
</tr>

<tr>
<td class="org-right">4.27213225e-06</td>
<td class="org-right">3.18251401e-06</td>
<td class="org-right">0.999992545</td>
</tr>

<tr>
<td class="org-right">0.33424463</td>
<td class="org-right">0.165758764</td>
<td class="org-right">0.499996606</td>
</tr>

<tr>
<td class="org-right">0.412980267</td>
<td class="org-right">0.567320655</td>
<td class="org-right">0.0196990781</td>
</tr>

<tr>
<td class="org-right">0.000562883648</td>
<td class="org-right">0.999314846</td>
<td class="org-right">0.000122270683</td>
</tr>

<tr>
<td class="org-right">4.31412781e-05</td>
<td class="org-right">0.999941751</td>
<td class="org-right">1.51075448e-05</td>
</tr>

<tr>
<td class="org-right">0.0369685485</td>
<td class="org-right">0.962937403</td>
<td class="org-right">9.40488833e-05</td>
</tr>

<tr>
<td class="org-right">0.00194860404</td>
<td class="org-right">0.00149510445</td>
<td class="org-right">0.996556292</td>
</tr>

<tr>
<td class="org-right">8.78636249e-05</td>
<td class="org-right">6.5779301e-05</td>
<td class="org-right">0.999846357</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python">jnp.std(a, axis=0)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">0.000504224632</td>
<td class="org-right">0.000430851732</td>
<td class="org-right">0.000425736141</td>
</tr>

<tr>
<td class="org-right">0.000201331771</td>
<td class="org-right">0.000160899138</td>
<td class="org-right">0.000260155704</td>
</tr>

<tr>
<td class="org-right">0.00817992169</td>
<td class="org-right">0.00073537618</td>
<td class="org-right">0.00816306802</td>
</tr>

<tr>
<td class="org-right">1.15421329e-05</td>
<td class="org-right">1.23829438e-05</td>
<td class="org-right">4.71130902e-06</td>
</tr>

<tr>
<td class="org-right">0.00379258354</td>
<td class="org-right">9.79363258e-05</td>
<td class="org-right">0.00379762501</td>
</tr>

<tr>
<td class="org-right">4.20493956e-06</td>
<td class="org-right">3.23946734e-06</td>
<td class="org-right">5.49460847e-06</td>
</tr>

<tr>
<td class="org-right">0.00377245123</td>
<td class="org-right">0.00370949123</td>
<td class="org-right">0.00260962516</td>
</tr>

<tr>
<td class="org-right">0.00104838995</td>
<td class="org-right">0.000931723461</td>
<td class="org-right">0.00089042298</td>
</tr>

<tr>
<td class="org-right">0.000537686972</td>
<td class="org-right">0.000551108567</td>
<td class="org-right">0.000118409269</td>
</tr>

<tr>
<td class="org-right">4.25035248e-05</td>
<td class="org-right">4.46105123e-05</td>
<td class="org-right">1.5382807e-05</td>
</tr>

<tr>
<td class="org-right">0.00490026012</td>
<td class="org-right">0.00489873334</td>
<td class="org-right">9.61223634e-05</td>
</tr>

<tr>
<td class="org-right">0.00196953449</td>
<td class="org-right">0.00149442043</td>
<td class="org-right">0.00243452455</td>
</tr>

<tr>
<td class="org-right">8.44661563e-05</td>
<td class="org-right">6.58645259e-05</td>
<td class="org-right">0.000104433532</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org612e3ab" class="outline-3">
<h3 id="org612e3ab">Version hiérarchique</h3>
<div class="outline-text-3" id="text-org612e3ab">
<p>
Dans la version hiérarchique du modèle chaque circonscription a sa propre matrice de trasnssition
</p>

<p>
Elle est assez simple à implémenter avec <code>aesara</code>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aesara.tensor <span style="font-weight: bold;">as</span> at
<span style="font-weight: bold;">from</span> aesara.tensor.random <span style="font-weight: bold;">import</span> RandomStream

<span style="font-weight: bold; font-style: italic;">srng</span> = RandomStream(0)

<span style="font-weight: bold; font-style: italic;">p1_at</span> = at.as_tensor(premier / premier.<span style="font-weight: bold;">sum</span>(axis=1).reshape((premier.shape[0], 1)))

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Hyperprior</span>
<span style="font-weight: bold; font-style: italic;">lambda_at</span> = at.as_tensor(2.)
<span style="font-weight: bold; font-style: italic;">delta_rv</span> = srng.exponential(at.ones((n_premier, n_second)) / lambda_at)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">We have one transition matrix per circonscription</span>
<span style="font-weight: bold; font-style: italic;">beta_rv</span> = srng.dirichlet(at.stack([delta_rv <span style="font-weight: bold;">for</span> _ <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">range</span>(n_examples)]))

<span style="font-weight: bold; font-style: italic;">p2_at</span> = at.dot(p1_at, beta_rv)
<span style="font-weight: bold; font-style: italic;">p2_at_norm</span> = p2_at<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">/ p2_at.sum(axis=-1).reshape((n_examples, p2_at.shape[2], 1))</span>
<span style="font-weight: bold; font-style: italic;">R2_rv</span> = srng.multinomial(at.<span style="font-weight: bold;">sum</span>(second, axis=1), p2_at_norm)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0e99a06" class="outline-2">
<h2 id="org0e99a06"><span class="todo TODO">TODO</span> Rappeler les résultats des deux tours</h2>
</div>
<div id="outline-container-orge79d351" class="outline-2">
<h2 id="orge79d351"><span class="todo TODO">TODO</span> Remontrer les courbes X vs Y</h2>
</div>
<div id="outline-container-org4460c50" class="outline-2">
<h2 id="org4460c50"><span class="todo TODO">TODO</span> Modèle full mixing pour tous les paramètres</h2>
</div>
</div>
</body>
</html>
