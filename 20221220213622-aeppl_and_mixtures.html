<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-01-01 Mon 16:45 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AePPL, discrete mixtures and conditionals</title>
<meta name="author" content="RÃ©mi Louf" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="style.css" /><script data-goatcounter="https://thetypicalset.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">AePPL, discrete mixtures and conditionals</h1>
<p>
Let us consider a family of probability distributions \(\left\{\mathbb{P}_\mu : \mu \in \mathcal{M} \right\}\) where \(\mathcal{M} = \left\{1, \dots, K\right\}\) and \(\mathbb{Q}\) a probability distribution on the domain \(\mathcal{M}\). A discrete mixture model assumes that the value of a random variable \(Y\) can be drawm from one of the \(\mathbb{P}_\mu\): at each step we draw one value \(m \in \mathcal{M}\)  from \(\mathbb{Q}\), and then draw from \(\mathbb{P}_m\).
</p>

<p>
We can then write the likelihood of \(Y\) conditional on \(m\) as:
</p>

<p>
\[
\mathbb{P}(Y \mid  z) = \mathbb{P}_z(Y)
\]
</p>

<p>
Many probabilistic programming languages implement mixture via an ad-hoc <code>Mixture</code> <a target='_blank' rel='noopener noreferrer' class='external' href="https://docs.pymc.io/en/v5.0.0/api/distributions/generated/pymc.Mixture.html#pymc.Mixture">distribution object</a>. In <a href="20220729163627-aesara.html#ID-5a5e87b1-558c-43db-ad38-32a073b10351">Aesara</a>/<a href="20220824141859-aeppl.html#ID-e18d689a-392a-407a-941a-f0ad2d2dc43e">AePPL</a> mixtures are expressed via the generative process described above, using the following Aesara constructs:
</p>
<ul class="org-ul">
<li>Indexing an array with a random variable;</li>
<li><code>aesara.tensor.where</code>;</li>
<li><code>aesara.ifelse.ifelse</code>.</li>
</ul>


<div id="outline-container-org0ac3eef" class="outline-2">
<h2 id="org0ac3eef">Indexing an array</h2>
<div class="outline-text-2" id="text-org0ac3eef">
<p>
We can define mixture by using a random variable with a discrete support (<code>Bernoulli</code>, <code>Categorical</code>, etc.) to index an array of random variables:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> aeppl
<span style="color: #F0DFAF; font-weight: bold;">import</span> aesara
<span style="color: #F0DFAF; font-weight: bold;">import</span> aesara.tensor <span style="color: #F0DFAF; font-weight: bold;">as</span> at
<span style="color: #F0DFAF; font-weight: bold;">import</span> numpy <span style="color: #F0DFAF; font-weight: bold;">as</span> np

<span style="color: #DFAF8F;">srng</span> = at.random.RandomStream(0)

<span style="color: #DFAF8F;">loc</span> = np.array([-1, 0, 1, 2])
<span style="color: #DFAF8F;">N_rv</span> = srng.normal(loc, 1.)

<span style="color: #DFAF8F;">p</span> = np.array([0.2, 0.3, 0.1, 0.4])
<span style="color: #DFAF8F;">I_rv</span> = srng.categorical(p)

<span style="color: #DFAF8F;">Y_rv</span> = N_rv[I_rv]

<span style="color: #DFAF8F;">sample_fn</span> = aesara.function((), Y_rv)
<span style="color: #F0DFAF; font-weight: bold;">print</span>(sample_fn())


logprob, (y_vv, i_vv) = aeppl.joint_logprob(Y_rv, I_rv)
<span style="color: #DFAF8F;">logprob_fn</span> = aesara.function((y_vv, i_vv), logprob)
<span style="color: #F0DFAF; font-weight: bold;">print</span>(logprob_fn(10, 0))
</pre>
</div>
</div>
</div>


<div id="outline-container-orgab48744" class="outline-2">
<h2 id="orgab48744">Using <code>aesara.tensor.where</code></h2>
<div class="outline-text-2" id="text-orgab48744">
<p>
We can also define mixtures using <code>aesara.tensor.where</code>; the conditional can be based on other random variables:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> aeppl
<span style="color: #F0DFAF; font-weight: bold;">import</span> aesara
<span style="color: #F0DFAF; font-weight: bold;">import</span> aesara.tensor <span style="color: #F0DFAF; font-weight: bold;">as</span> at


<span style="color: #DFAF8F;">srng</span> = at.random.RandomStream(0)

<span style="color: #DFAF8F;">x_rv</span> = srng.normal(0, 1)
<span style="color: #DFAF8F;">y_rv</span> = srng.cauchy(0, 1)
<span style="color: #DFAF8F;">i_rv</span> = srng.normal(0, 2)

<span style="color: #DFAF8F;">Y_rv</span> = at.where(at.ge(i_rv, 1.), x_rv, y_rv)

<span style="color: #DFAF8F;">sample_fn</span> = aesara.function((), Y_rv)
<span style="color: #F0DFAF; font-weight: bold;">print</span>(sample_fn())

logprob, (y_vv, i_vv) = aeppl.joint_logprob(y_rv, i_rv)
<span style="color: #DFAF8F;">logprob_fn</span> = aesara.function((y_vv, i_vv), logprob)
<span style="color: #F0DFAF; font-weight: bold;">print</span>(logprob_fn(10, -1.))
</pre>
</div>
</div>
</div>


<div id="outline-container-org0cd729c" class="outline-2">
<h2 id="org0cd729c"><span class="todo TODO">TODO</span> Using <code>aeara.ifelse.ifelse</code></h2>
<div class="outline-text-2" id="text-org0cd729c">
<p>
We also <a target='_blank' rel='noopener noreferrer' class='external' href="https://github.com/aesara-devs/aeppl/pull/169">soon</a> be able to use <code>aesara.ifelse</code> to define mixures in the same way we use <code>aesara.tensor.where</code>:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> aeppl
<span style="color: #F0DFAF; font-weight: bold;">import</span> aesara
<span style="color: #F0DFAF; font-weight: bold;">import</span> aesata.tensor <span style="color: #F0DFAF; font-weight: bold;">as</span> at


<span style="color: #DFAF8F;">srng</span> = at.random.RandomStream(0)

<span style="color: #DFAF8F;">x_rv</span> = srng.normal(0, 1)
<span style="color: #DFAF8F;">y_rv</span> = srng.cauchy(0, 1)
<span style="color: #DFAF8F;">i_rv</span> = srng.bernoulli(0.5)

<span style="color: #DFAF8F;">Y_rv</span> = aesara.ifelse(i_rv, x_rv, y_rv)

logprob, (y_vv, i_vv) = aeppl.joint_logprob(Y_rv, i_rv)
</pre>
</div>
</div>
</div>

<div id="outline-container-org15d89e6" class="outline-2">
<h2 id="org15d89e6">Links to this note</h2>
<div class="outline-text-2" id="text-org15d89e6">
<ul class="org-ul">
<li><a href="./20221220220656-aeppl_and_marginalization.html">AePPL and marginalization</a></li>
<li><a href="./20220824141859-aeppl.html">AePPL</a></li>
</ul>
</div>
</div>
</div>
</body>
</html>
